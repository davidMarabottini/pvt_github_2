name: CV PDF Generation and External Push

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate_cv:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout: Clona il repository principale
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        
      # 2. Setup Java: Installa Java (necessario per FOP)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Scarica Apache FOP
      - name: Download Apache FOP from Archive
        run: |
          FOP_VERSION="2.9"
          FOP_NAME="apache-fop-${FOP_VERSION}" # <-- DEVE ESSERE INCLUSO "apache-"
          ARCHIVE_URL="https://archive.apache.org/dist/xmlgraphics/fop/binaries/${FOP_NAME}-bin.tar.gz"
          
          echo "Attempting to download FOP from: $ARCHIVE_URL"
          wget $ARCHIVE_URL
          
          tar xvfz ${FOP_NAME}-bin.tar.gz
          # Rinominare la cartella estratta (apache-fop-2.9) in 'fop'
          mv ${FOP_NAME} fop 
          echo "FOP_HOME=$(pwd)/fop" >> $GITHUB_ENV

      # 4. Esecuzione di FOP (Generazione del PDF)
      - name: Generate CV PDF
        run: |
          mkdir -p artifact # Crea la cartella temporanea
          
          # Esecuzione diretta del JAR principale di FOP (questo è il modo più pulito)
          # NOTA: Qui ipotizziamo che il file fop.jar sia nella root di fop, il che è vero nella versione binaria
          java -jar "${FOP_HOME}/fop.jar" \
            -xml dummy.xml \
            -xsl onepagecv.xsl \
            -pdf artifact/Curriculum_Vitae.pdf \
            -param lang it \
            -param root_folder david_marabottini_expanded
        shell: bash
        env:
          FOP_HOME: ${{ env.FOP_HOME }}

      # 5. Push al repository di destinazione
      - name: Push CV PDF to External Repository
        uses: dmnemec/copy_file_to_another_repo_action@main 
        env:
          # Usa il Secret API_TOKEN_GITHUB con il PAT
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }} 
        with:
          source_file: 'artifact/Curriculum_Vitae.pdf' 
          # *** SOSTITUISCI QUI CON IL TUO NOME UTENTE E REPO DI DESTINAZIONE ***
          destination_repo: 'davidmarabottini/pvt_github_1' 
          destination_folder: 'CV_Artifacts/'
          commit_message: 'Auto-generated CV PDF from FOP, commit ${{ github.sha }}'