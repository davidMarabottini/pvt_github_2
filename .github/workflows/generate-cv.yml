name: CV PDF Generation and External Push

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate_cv:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout repository principale
      - name: Checkout Source Repo
        uses: actions/checkout@v4

      # 2. Setup Java 17 (necessario per FOP)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Scarica e installa Apache FOP binario
      - name: Download Apache FOP Binary
        run: |
          FOP_VERSION="2.9"
          FOP_NAME="fop-${FOP_VERSION}"
          ARCHIVE_URL="https://archive.apache.org/dist/xmlgraphics/fop/binaries/${FOP_NAME}-bin.tar.gz"

          echo "Downloading FOP from: $ARCHIVE_URL"
          wget $ARCHIVE_URL

          # Estrai i file
          tar xvfz ${FOP_NAME}-bin.tar.gz
          mv ${FOP_NAME} fop
          echo "FOP_HOME=$(pwd)/fop" >> $GITHUB_ENV

          # Debug: verifica struttura FOP
          echo "Listing FOP root:"
          ls -l fop
          echo "Listing FOP internal directory:"
          ls -l fop/fop
          echo "Listing FOP lib directory:"
          ls -l fop/fop/lib

      # 4. Genera il PDF con FOP
      - name: Generate CV PDF
        run: |
          chmod +x $FOP_HOME/fop/fop

          # Esegui lo script FOP
          $FOP_HOME/fop/fop \
            -c ${GITHUB_WORKSPACE}/fop.xconf \
            -xml ${GITHUB_WORKSPACE}/dummy.xml \
            -xsl ${GITHUB_WORKSPACE}/onepagecv.xsl \
            -pdf ${GITHUB_WORKSPACE}/david_marabottini_expanded/it/cv_david_one_page.pdf \
            -param lang it \
            -param root_folder david_marabottini_expanded
        shell: bash
        env:
          FOP_HOME: ${{ env.FOP_HOME }}

      # 5. Copia e push del PDF generato su repository esterno
      - name: Push CV PDF to External Repository
        uses: dmnemec/copy_file_to_another_repo_action@main 
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source_file: 'david_marabottini_expanded/it/cv_david_one_page.pdf'
          destination_repo: 'davidmarabottini/pvt_github_1'
          destination_folder: 'CV_Artifacts/'
          commit_message: 'Auto-generated CV PDF from FOP, commit ${{ github.sha }}'
