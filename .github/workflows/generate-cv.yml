name: CV PDF Generation and External Push

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate_cv:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout: Clona il repository principale
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        
      # 2. Setup Java: Installa Java (necessario per FOP)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. Scarica Apache FOP
      - name: Download Apache FOP from Archive
        run: |
          FOP_VERSION="2.9"
          FOP_NAME="fop-${FOP_VERSION}"
          # *** MODIFICA QUI IL PERCORSO DI DOWNLOAD VERSO L'ARCHIVIO STORICO ***
          ARCHIVE_URL="https://archive.apache.org/dist/xmlgraphics/fop/binaries/${FOP_NAME}-bin.tar.gz"
          
          echo "Attempting to download FOP from: $ARCHIVE_URL"
          wget $ARCHIVE_URL
          
          # Estrai i file
          tar xvfz ${FOP_NAME}-bin.tar.gz
          # Rinomina e imposta FOP_HOME per gli step successivi
          mv ${FOP_NAME} fop
          echo "FOP_HOME=$(pwd)/fop" >> $GITHUB_ENV
          ls $(pwd)/fop

      # 4. Esecuzione di FOP (Generazione del PDF)
      # - name: Debug FOP installation
      #   run: |
      #     echo "FOP_HOME = $(pwd)"
      #     ls -l $FOP_HOME/lib
      #     ls -l $FOP_HOME/fop
          
      - name: Generate CV PDF
        run: |
          chmod +x $FOP_HOME/fop/fop

          $FOP_HOME/fop/fop \
            -c ${GITHUB_WORKSPACE}/fop.xconf \
            -xml ${GITHUB_WORKSPACE}/dummy.xml \
            -xsl ${GITHUB_WORKSPACE}/onepagecv.xsl \
            -pdf ${GITHUB_WORKSPACE}/david_marabottini_expanded/it/cv_david_one_page.pdf \
            -param lang it \
            -param root_folder david_marabottini_expanded
        shell: bash


      # 5. Push al repository di destinazione
      - name: Push CV PDF to External Repository
        uses: dmnemec/copy_file_to_another_repo_action@main 
        env:
          # Usa il Secret API_TOKEN_GITHUB con il PAT
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }} 
        with:
          source_file: 'artifact/Curriculum_Vitae.pdf' 
          # *** SOSTITUISCI QUI CON IL TUO NOME UTENTE E REPO DI DESTINAZIONE ***
          destination_repo: 'davidmarabottini/pvt_github_1' 
          destination_folder: 'CV_Artifacts/'
          commit_message: 'Auto-generated CV PDF from FOP, commit ${{ github.sha }}'
